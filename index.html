<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Criminal & Employee Detection</title>
<style>
  body { font-family: sans-serif; background: #111; color: #eee; text-align: center; }
  button { margin: 5px; padding: 10px 20px; }
  video { border: 2px solid #0ea5a4; border-radius: 8px; margin-top: 10px; }
  #log { background:#222; padding:10px; margin-top:10px; height:200px; overflow:auto; text-align:left; font-family:monospace; }
</style>
</head>
<body>

<h1>Criminal / Employee Detection</h1>
<button id="trainBtn">Train</button>
<button id="detectBtn">Detect</button>

<div id="trainSection" style="display:none; margin-top:20px;">
  <h2>Upload Training Images</h2>
  <div>
    <h3>Criminals</h3>
    <input type="text" id="criminalLabel" placeholder="Criminal Name">
    <input type="file" id="criminalFiles" multiple accept="image/*">
    <button id="uploadCriminals">Upload Criminals</button>
  </div>
  <div>
    <h3>Employees</h3>
    <input type="text" id="employeeLabel" placeholder="Employee Name">
    <input type="file" id="employeeFiles" multiple accept="image/*">
    <button id="uploadEmployees">Upload Employees</button>
  </div>
  <div>
    <h3>Custom Siren</h3>
    <input type="file" id="sirenFile" accept="audio/*">
  </div>
</div>

<div id="detectSection" style="display:none; margin-top:20px;">
  <h2>Live Detection</h2>
  <video id="video" width="400" height="300" autoplay muted></video>
  <div>
    <button id="startDetect">Start Detection</button>
    <button id="stopDetect">Stop Detection</button>
  </div>
</div>

<div id="log"></div>
<audio id="siren" src="" preload="auto"></audio>

<script src="https://cdn.jsdelivr.net/npm/face-api.js"></script>
<script>
const logEl = document.getElementById('log');
function log(msg){ logEl.innerHTML = `[${new Date().toLocaleTimeString()}] ${msg}<br>` + logEl.innerHTML; }

let db = { criminals: [], employees: [] };
let modelsLoaded = false;
let videoStream;
let interval;
let faceMatcher;
let siren = document.getElementById('siren');

async function loadModels() {
  if(modelsLoaded) return;
  log("Loading face-api models...");
  await faceapi.nets.ssdMobilenetv1.loadFromUri('https://justadudewhohacks.github.io/face-api.js/models/');
  await faceapi.nets.faceRecognitionNet.loadFromUri('https://justadudewhohacks.github.io/face-api.js/models/');
  await faceapi.nets.faceLandmark68Net.loadFromUri('https://justadudewhohacks.github.io/face-api.js/models/');
  modelsLoaded = true;
  log("Models loaded.");
}

// Train upload handlers
async function processFiles(files, label, type){
  await loadModels();
  for(const f of files){
    const img = await fileToImage(f);
    const desc = await faceapi.detectSingleFace(img).withFaceLandmarks().withFaceDescriptor();
    if(!desc) { log(`No face detected in ${f.name}`); continue; }
    if(!db[type][label]) db[type][label] = [];
    db[type][label].push(Array.from(desc.descriptor));
    log(`Processed ${f.name} as ${label}`);
  }
}

function fileToImage(file){
  return new Promise((res, rej)=>{
    const img = new Image();
    img.onload = ()=>res(img);
    img.onerror = e=>rej(e);
    const reader = new FileReader();
    reader.onload = e=> img.src = e.target.result;
    reader.readAsDataURL(file);
  });
}

// Detect
async function startDetection(){
  await loadModels();
  const labeledDescriptors = [];
  for(const [label, arrs] of Object.entries(db.criminals)) labeledDescriptors.push(new faceapi.LabeledFaceDescriptors('CRIMINAL::'+label, arrs.map(a=>new Float32Array(a))));
  for(const [label, arrs] of Object.entries(db.employees)) labeledDescriptors.push(new faceapi.LabeledFaceDescriptors('EMPLOYEE::'+label, arrs.map(a=>new Float32Array(a))));
  faceMatcher = new faceapi.FaceMatcher(labeledDescriptors, 0.6);

  videoStream = await navigator.mediaDevices.getUserMedia({video:true, audio:false});
  const video = document.getElementById('video');
  video.srcObject = videoStream;

  interval = setInterval(async ()=>{
    const detections = await faceapi.detectAllFaces(video).withFaceLandmarks().withFaceDescriptors();
    for(const d of detections){
      const best = faceMatcher.findBestMatch(d.descriptor);
      if(best.label.startsWith('CRIMINAL::')){
        log(`CRIMINAL detected: ${best.label.replace('CRIMINAL::','')}`);
        siren.play();
      }else if(best.label.startsWith('EMPLOYEE::')){
        log(`EMPLOYEE detected: ${best.label.replace('EMPLOYEE::','')}`);
        siren.play();
      }else{
        log(`UNKNOWN detected`);
        siren.play();
      }
    }
  }, 1000);
}

function stopDetection(){
  clearInterval(interval);
  if(videoStream) videoStream.getTracks().forEach(t=>t.stop());
  log("Detection stopped.");
}

// Mode buttons
document.getElementById('trainBtn').onclick = ()=>{ document.getElementById('trainSection').style.display='block'; document.getElementById('detectSection').style.display='none'; }
document.getElementById('detectBtn').onclick = ()=>{ document.getElementById('trainSection').style.display='none'; document.getElementById('detectSection').style.display='block'; }

// Upload buttons
document.getElementById('uploadCriminals').onclick = ()=>processFiles(document.getElementById('criminalFiles').files, document.getElementById('criminalLabel').value, 'criminals');
document.getElementById('uploadEmployees').onclick = ()=>processFiles(document.getElementById('employeeFiles').files, document.getElementById('employeeLabel').value, 'employees');

// Siren
document.getElementById('sirenFile').onchange = e=>siren.src = URL.createObjectURL(e.target.files[0]);

// Start/Stop detection
document.getElementById('startDetect').onclick = startDetection;
document.getElementById('stopDetect').onclick = stopDetection;

</script>
</body>
</html>
