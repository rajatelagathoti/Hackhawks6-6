<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Criminal / Employee Detection</title>
<style>
  body { font-family: sans-serif; background: #111; color: #eee; text-align: center; margin:0; }
  button, select { margin: 5px; padding: 10px 20px; cursor: pointer; }
  .video-wrapper {
    width: 100%;
    height: 70vh;
    margin: auto;
    position: relative;
    background: black;
    border: 4px solid green;
    border-radius: 20px;
    overflow: hidden;
    transition: border-color 0.3s ease;
  }
  video {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }
  #log { background:#222; padding:10px; margin-top:10px; height:200px; overflow:auto; text-align:left; font-family:monospace; }
</style>
</head>
<body>

<h1>Criminal / Employee Detection</h1>
<button id="trainBtn">Train</button>
<button id="detectBtn">Detect</button>

<div id="trainSection" style="display:none; margin-top:20px;">
  <h2>Upload Photos & (Optional) Sirens</h2>
  <div>
    <h3>Criminal Photos</h3>
    <input type="file" id="criminalFiles" multiple accept="image/*">
    <button id="uploadCriminals">Upload Criminals</button>
    <br>
    <h4>Upload Criminal Siren (optional)</h4>
    <input type="file" id="sirenCriminal" accept="audio/*">
  </div>
  <div>
    <h3>Employee Photos</h3>
    <input type="file" id="employeeFiles" multiple accept="image/*">
    <button id="uploadEmployees">Upload Employees</button>
    <br>
    <h4>Upload Employee Siren (optional)</h4>
    <input type="file" id="sirenEmployee" accept="audio/*">
  </div>
  <div>
    <h3>Unknown Siren (optional)</h3>
    <input type="file" id="sirenUnknownUpload" accept="audio/*">
  </div>
</div>

<div id="detectSection" style="display:none; margin-top:20px;">
  <h2>Live Detection</h2>
  <button id="switchCameraBtn">Switch Camera</button>
  <div class="video-wrapper" id="videoWrapper">
    <video id="video" autoplay muted playsinline></video>
  </div>
</div>

<div id="log"></div>
<!-- Default sirens -->
<audio id="sirenCr" src="criminal.mp3" preload="auto"></audio>
<audio id="sirenEmp" src="employee.mp3" preload="auto"></audio>
<audio id="sirenUnknown" src="unknown.mp3" preload="auto"></audio>

<script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>
<script>
const logEl = document.getElementById('log');
function log(msg){ logEl.innerHTML = `[${new Date().toLocaleTimeString()}] ${msg}<br>` + logEl.innerHTML; }

let db = { criminals: [], employees: [] };
let modelsLoaded = false;
let videoStream;
let interval;
let faceMatcher;
let currentCamera = 'user';

const video = document.getElementById('video');
const videoWrapper = document.getElementById('videoWrapper');
const sirenCr = document.getElementById('sirenCr');
const sirenEmp = document.getElementById('sirenEmp');
const sirenUnknown = document.getElementById('sirenUnknown');

async function loadModels() {
  if(modelsLoaded) return;
  log("Loading face-api models...");
  await faceapi.nets.ssdMobilenetv1.loadFromUri('https://justadudewhohacks.github.io/face-api.js/models/');
  await faceapi.nets.faceRecognitionNet.loadFromUri('https://justadudewhohacks.github.io/face-api.js/models/');
  await faceapi.nets.faceLandmark68Net.loadFromUri('https://justadudewhohacks.github.io/face-api.js/models/');
  modelsLoaded = true;
  log("Models loaded.");
}

function fileToImage(file){
  return new Promise((res, rej)=>{
    const img = new Image();
    img.onload = ()=>res(img);
    img.onerror = e=>rej(e);
    const reader = new FileReader();
    reader.onload = e=> img.src = e.target.result;
    reader.readAsDataURL(file);
  });
}

async function processFiles(files, type){
  await loadModels();
  for(const f of files){
    const img = await fileToImage(f);
    const det = await faceapi.detectSingleFace(img).withFaceLandmarks().withFaceDescriptor();
    if(!det) { log(`No face detected in ${f.name}`); continue; }
    db[type].push(Array.from(det.descriptor));
    log(`Processed ${f.name} as ${type}`);
  }
}

// Switch camera
async function switchCamera() {
  currentCamera = (currentCamera === 'user') ? 'environment' : 'user';
  log(`Switching camera to: ${currentCamera}`);
  if(videoStream) videoStream.getTracks().forEach(t => t.stop());
  startDetection();
}

// Start detection
async function startDetection(){
  await loadModels();
  if(db.criminals.length===0 && db.employees.length===0){
    log("Upload some photos first!");
    return;
  }

  const labeledDescriptors = [];
  if(db.criminals.length>0) labeledDescriptors.push(new faceapi.LabeledFaceDescriptors('CRIMINAL', db.criminals.map(a=>new Float32Array(a))));
  if(db.employees.length>0) labeledDescriptors.push(new faceapi.LabeledFaceDescriptors('EMPLOYEE', db.employees.map(a=>new Float32Array(a))));
  faceMatcher = new faceapi.FaceMatcher(labeledDescriptors, 0.6);

  try {
    videoStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: currentCamera }, audio: false });
    video.srcObject = videoStream;

    // Mirror only for front camera
    video.style.transform = (currentCamera==='user') ? 'scaleX(-1)' : 'scaleX(1)';

    interval = setInterval(async ()=>{
      const detections = await faceapi.detectAllFaces(video).withFaceLandmarks().withFaceDescriptors();
      for(const d of detections){
        const best = faceMatcher.findBestMatch(d.descriptor);
        if(best.label==='CRIMINAL'){
          log("CRIMINAL detected!");
          videoWrapper.style.borderColor = "red";
          sirenCr.play();
        } else if(best.label==='EMPLOYEE'){
          log("EMPLOYEE detected!");
          videoWrapper.style.borderColor = "green";
          sirenEmp.play();
        } else{
          log("UNKNOWN detected!");
          videoWrapper.style.borderColor = "yellow";
          sirenUnknown.play();
        }
      }
    }, 1000);
    log("Detection started.");
  } catch(err){
    log("Error accessing camera: "+err.message);
    alert("Camera error: " + err.message);
  }
}

function stopDetection(){
  clearInterval(interval);
  if(videoStream) videoStream.getTracks().forEach(t=>t.stop());
  log("Detection stopped.");
}

// Mode buttons
document.getElementById('trainBtn').onclick = ()=>{ 
  document.getElementById('trainSection').style.display='block'; 
  document.getElementById('detectSection').style.display='none'; 
  stopDetection();
}
document.getElementById('detectBtn').onclick = ()=>{ 
  document.getElementById('trainSection').style.display='none'; 
  document.getElementById('detectSection').style.display='block'; 
  startDetection();
}

// Upload buttons
document.getElementById('uploadCriminals').onclick = ()=>processFiles(document.getElementById('criminalFiles').files, 'criminals');
document.getElementById('uploadEmployees').onclick = ()=>processFiles(document.getElementById('employeeFiles').files, 'employees');

// Sirens override defaults if uploaded
document.getElementById('sirenCriminal').onchange = e=>sirenCr.src = URL.createObjectURL(e.target.files[0]);
document.getElementById('sirenEmployee').onchange = e=>sirenEmp.src = URL.createObjectURL(e.target.files[0]);
document.getElementById('sirenUnknownUpload').onchange = e=>sirenUnknown.src = URL.createObjectURL(e.target.files[0]);

// Camera switch
document.getElementById('switchCameraBtn').onclick = switchCamera;
</script>
</body>
</html>
